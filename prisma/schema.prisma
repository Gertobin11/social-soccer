// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id            String  @id @unique
    email         String  @unique
    emailVerified Boolean
    passwordHash  String
    firstName     String?
    lastName      String?
    addressID     Int?

    address            Address?             @relation(fields: [addressID], references: [id])
    sessions           Session[]
    passwordResetToken PasswordResetToken[]
    games              Game[]               @relation("playersInGame")
    ratings            Rating[]
    emailVerification  EmailVerification[]
    requestsToJoin     RequestToJoin[]
}

model Address {
    id            Int    @id @default(autoincrement())
    lineOne       String
    lineTwo       String
    city          String
    county        String
    country       String
    eircode       String
    coordinatesID Int    @unique

    users       User[]
    coordinates Coordinates @relation(fields: [coordinatesID], references: [id], onDelete: Cascade)

    game Game?
}

model Coordinates {
    id       Int                                   @id @default(autoincrement())
    // using postgis for geospatial enquiries
    location Unsupported("geography(Point, 4326)")
    address  Address?

    @@index([location], type: Gist)
}

model Session {
    token     String   @id @unique
    userID    String
    expiresAt DateTime

    user User @relation(fields: [userID], references: [id], onDelete: Cascade)
}

model EmailVerification {
    id      String @id @unique
    userID  String
    expires BigInt

    user User @relation(references: [id], fields: [userID], onDelete: Cascade)
}

model PasswordResetToken {
    token     String   @id @unique
    userID    String
    expiresAt DateTime

    user User @relation(fields: [userID], references: [id], onDelete: Cascade)
}

enum Level {
    BEGINNER
    RECREATIONAL
    INTERMEDITE
    COMPETITIVE
    ADVANCED
}

model Game {
    id              Int      @id @default(autoincrement())
    organiserID     String
    locationID      Int      @unique
    time            String
    day             String
    numberOfPlayers Int
    active          Boolean
    createdOn       DateTime @default(now())

    location    Address  @relation(references: [id], fields: [locationID], onDelete: Cascade)
    level       Level
    players     User[]   @relation("playersInGame")
    rating      Rating[]

    requestsToJoin RequestToJoin[]
}

model Rating {
    id       Int      @id @default(autoincrement())
    playerID String
    gameID   Int
    rating   Int
    ratedOn  DateTime @default(now())

    game   Game @relation(fields: [gameID], references: [id])
    player User @relation(fields: [playerID], references: [id])

    @@unique([gameID, playerID], name: "uniqueRating")
}

model RequestToJoin {
    id        Int      @id @default(autoincrement())
    gameID    Int
    playerID  String
    createdOn DateTime @default(now())
    accepted  Boolean?

    game   Game @relation(fields: [gameID], references: [id])
    player User @relation(fields: [playerID], references: [id])

    @@unique([gameID, playerID], name: "requestToPlayer")
}
